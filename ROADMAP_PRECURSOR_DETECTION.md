# üéØ ROADMAP: PRECURSOR DETECTION

**–°—Ç–∞—Ç—É—Å:** –û–¢–õ–û–ñ–ï–ù–û (–¥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô ‚≠ê‚≠ê‚≠ê  
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –•–û–ß–ï–¢ –í–ö–õ–Æ–ß–ò–¢–¨ –ö–û–ì–î–ê –ù–ê–°–¢–ê–ù–ï–¢ –í–†–ï–ú–Ø!!!

---

## üìã –ß–¢–û –≠–¢–û

**Precursor Detection** - –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ "–ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–æ–≤" —Å–æ–±—ã—Ç–∏–π.

**–ò–¥–µ—è:** –ï—Å–ª–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≥–ª—é—á–∏—Ç –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è, –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑—å?

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:** –ù–∞–±–ª—é–¥–∞–µ–º, –Ω–µ –æ–±—ä—è—Å–Ω—è–µ–º. –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è - —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å.

---

## ‚è∞ –ö–û–ì–î–ê –í–ö–õ–Æ–ß–ê–¢–¨

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- ‚úÖ **30+ –¥–Ω–µ–π** –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ **100+ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π** –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
- ‚úÖ **–ö–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Ä–æ–≥–∏** (auto-calibrator –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É)
- ‚úÖ **Brier score < 0.25** (—Ö–æ—Ä–æ—à–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:
```bash
# –°–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
python3 -c "
import json
with open('logs/patterns/patterns.json', 'r') as f:
    patterns = json.load(f)
    
for key, events in patterns.items():
    count = list(events.values())[0]['condition_count']
    if count >= 100:
        print(f'‚úÖ {key}: {count} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π')
    else:
        print(f'‚è≥ {key}: {count}/100 –Ω–∞–±–ª—é–¥–µ–Ω–∏–π')
"
```

---

## üîß –ö–ê–ö –í–ö–õ–Æ–ß–ò–¢–¨

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
```bash
# –û—Ç–∫—Ä—ã—Ç—å logs/patterns/patterns.json
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –µ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å 100+ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º–∏
```

### 2. –í–∫–ª—é—á–∏—Ç—å –≤ –∫–æ–¥–µ
–§–∞–π–ª: `src/analyzers/online/cluster_detector.py`

–ù–∞–π—Ç–∏ –º–µ—Ç–æ–¥ `_check_precursor()` (—Å—Ç—Ä–æ–∫–∞ ~150)

**–°–µ–π—á–∞—Å:**
```python
def _check_precursor(self, anomaly: AnomalyEvent) -> AnomalyCluster | None:
    # DISABLED: Precursor detection requires much more data
    return None
```

**–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞:**
```python
def _check_precursor(self, anomaly: AnomalyEvent) -> AnomalyCluster | None:
    # ENABLED: Precursor detection with statistical validation
    
    # 1. –ù–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ precursor_window (1 —á–∞—Å)
    current_time = time.time()
    cutoff = current_time - self.precursor_window
    
    recent_events = [
        p for p in self._precursor_candidates 
        if p["timestamp"] >= cutoff
    ]
    
    if len(recent_events) < 2:
        return None
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    sources = set(e["anomaly"].sensor_source for e in recent_events)
    if len(sources) < 2:
        return None
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å–∏–ª—É –∞–Ω–æ–º–∞–ª–∏–∏
    min_strength = 5.0  # z_score >= 5.0
    if any(e["anomaly"].z_score < min_strength for e in recent_events):
        return None
    
    # 4. –í—ã—á–∏—Å–ª–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    time_diff = current_time - recent_events[0]["timestamp"]
    probability = self._calculate_precursor_probability(time_diff)
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∏–∑–∫–∞—è
    if probability > 0.05:  # p < 5%
        return None
    
    # 6. –°–æ–∑–¥–∞—Ç—å Level 5 –∫–ª–∞—Å—Ç–µ—Ä
    anomalies = [e["anomaly"] for e in recent_events]
    
    return AnomalyCluster(
        level=5,
        anomalies=anomalies,
        timestamp=current_time,
        probability=probability,
        description="–í–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫",
        is_precursor=True,
        precursor_event=anomaly
    )
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä–æ–≥–∏
–§–∞–π–ª: `src/analyzers/online/cluster_detector.py` (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)

```python
def __init__(
    self,
    cluster_window_seconds: float = 30.0,
    precursor_window_seconds: float = 3600.0,  # 1 —á–∞—Å
    min_precursor_observations: int = 100,  # –ú–∏–Ω–∏–º—É–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
    precursor_confidence_threshold: float = 0.05  # p < 5%
):
```

### 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
pkill -f "python.*main.py"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
python3 main.py
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ü–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–ª–µ–¥–∏—Ç—å –∑–∞:

1. **False Positive Rate** - —Å–∫–æ–ª—å–∫–æ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
   - –¶–µ–ª—å: < 5%
   - –ï—Å–ª–∏ –±–æ–ª—å—à–µ - —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä–æ–≥–∏

2. **True Positive Rate** - —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–æ–≤
   - –¶–µ–ª—å: > 20%
   - –ï—Å–ª–∏ –º–µ–Ω—å—à–µ - –æ—Å–ª–∞–±–∏—Ç—å –ø–æ—Ä–æ–≥–∏

3. **Brier Score** - –∫–∞—á–µ—Å—Ç–≤–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
   - –¶–µ–ª—å: < 0.25
   - –ï—Å–ª–∏ –±–æ–ª—å—à–µ - –Ω—É–∂–Ω–∞ —Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ precursor detection
grep "–í–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫" matrix_watcher.log | wc -l

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 precursor —Å–æ–±—ã—Ç–∏–π
grep "–í–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫" matrix_watcher.log | tail -10
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û

### –ù–ï –í–ö–õ–Æ–ß–ê–¢–¨ –ü–û–ö–ê:
- ‚ùå –ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö (< 30 –¥–Ω–µ–π)
- ‚ùå –ú–∞–ª–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π (< 100 –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω)
- ‚ùå –ü–æ—Ä–æ–≥–∏ –Ω–µ –æ—Ç–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω—ã
- ‚ùå Brier score –ø–ª–æ—Ö–æ–π (> 0.25)

### –ú–û–ñ–ù–û –í–ö–õ–Æ–ß–ê–¢–¨ –ö–û–ì–î–ê:
- ‚úÖ 30+ –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã
- ‚úÖ 100+ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω
- ‚úÖ Auto-calibrator –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É
- ‚úÖ Brier score < 0.25
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º

---

## üéØ –¶–ï–õ–¨

**–û–±–Ω–∞—Ä—É–∂–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–≤–µ—Å—Ç–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π** (–µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç).

**–ù–µ —Å–∏–º—É–ª—è—Ü–∏—è, –∞ –Ω–∞—Å—Ç–æ—è—â–∞—è –Ω–∞—É–∫–∞:**
- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ö–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏
- –ß–µ—Å—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
- –ù–∏–∫–∞–∫–æ–≥–æ —Ñ–µ–π–∫–∞

**–ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–µ–º "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç".**  
**–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–æ–∫–∞–∂–µ–º —Ü–∏—Ñ—Ä—ã.**

---

## üìÖ –ß–ï–ö–õ–ò–°–¢ –ê–ö–¢–ò–í–ê–¶–ò–ò

- [ ] –ü—Ä–æ—à–ª–æ 30+ –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
- [ ] –ï—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å 100+ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º–∏
- [ ] Auto-calibrator –∑–∞–≤–µ—Ä—à–∏–ª –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
- [ ] Brier score < 0.25
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª "–í–ö–õ–Æ–ß–ê–ô!"
- [ ] –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω (cluster_detector.py)
- [ ] –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ü–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

---

**–ó–ê–ü–û–ú–ù–ò–õ! –í–ö–õ–Æ–ß–ò–ú –ö–û–ì–î–ê –ù–ê–°–¢–ê–ù–ï–¢ –í–†–ï–ú–Ø! üéØ**

---

*–°–æ–∑–¥–∞–Ω–æ: 2025-12-16 21:35*  
*–°—Ç–∞—Ç—É—Å: –ñ–î–Å–ú –î–ê–ù–ù–´–•*  
*–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô ‚≠ê‚≠ê‚≠ê*
